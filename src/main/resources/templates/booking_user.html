<!-- booking_user.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Đặt phòng & Thanh toán</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Theme màu đồng bộ */
        .text-primary { color: #000 !important; }        /* chữ chính màu đen */
        .text-danger { color: #ef4444 !important; }      /* chữ đỏ price */
        .btn-primary { background-color: #0ea5e9; border-color: #0ea5e9; }
        .btn-primary:hover { background-color: #0284c7; border-color: #0284c7; }
        .card.bg-white { background-color: white !important; }
        #qrBox { border-top: 3px solid #0ea5e9; }        /* viền QR */
        #successBanner { display: none; margin-bottom: 20px; }
    </style>
</head>
<body class="bg-light">

<div class="container my-5">

    <!-- Banner thanh toán thành công -->
    <div class="alert alert-success text-center fw-bold" id="successBanner">
        Thanh toán thành công!
    </div>

    <div class="card shadow-lg rounded-4 p-4">

        <h1 class="text-center mb-5 text-primary fw-bold">ĐẶT PHÒNG KHÁCH SẠN</h1>

        <div class="row g-4">

            <!-- Thông tin phòng -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm p-3 bg-white">
                    <h5 class="fw-bold mb-3 text-primary">THÔNG TIN PHÒNG</h5>
                    <p class="text-primary fw-bold fs-4" th:text="${room.roomName}">Tên phòng</p>
                    <img th:src="@{${room.img}}" alt="Room Image" class="img-fluid rounded mb-3 shadow-sm"/>
                    <p class="text-danger fw-bold fs-5 mb-2"
                       th:text="${#numbers.formatDecimal(room.price,0,'POINT',0,'COMMA')} + ' VND'">0 VND</p>
                    <p class="text-muted mb-1">Nhận: <span id="checkInDisplay">-</span></p>
                    <p class="text-muted">Trả: <span id="checkOutDisplay">-</span></p>
                </div>
            </div>

            <!-- Form khách hàng -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm p-3 bg-white">
                    <h5 class="fw-bold mb-3 text-primary">THÔNG TIN KHÁCH HÀNG</h5>
                    <form id="bookingForm" th:action="@{/api/booking}" method="post">
                        <input type="hidden" name="roomId" th:value="${room.roomId}" />
                        <input type="hidden" name="checkIn" id="checkInInput" />
                        <input type="hidden" name="checkOut" id="checkOutInput" />

                        <div class="mb-3">
                            <label class="form-label">Họ tên</label>
                            <input name="customerName" type="text" required class="form-control"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input name="phone" type="text" required class="form-control"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <textarea name="note" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phương thức thanh toán</label>
                            <select name="paymentMethod" class="form-select">
                                <option value="CASH">Tiền mặt</option>
                                <option value="CARD">Thẻ</option>
                                <option value="ONLINE">Chuyển khoản (QR)</option>
                                <option value="VOUCHER">Voucher</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 fw-bold">Xác nhận</button>
                    </form>
                </div>
            </div>

        </div>

        <!-- QR Code -->
        <div class="card border-0 shadow-sm p-4 bg-white mt-4 text-center d-none" id="qrBox">
            <h5 class="fw-bold mb-3 text-primary">QR THANH TOÁN</h5>
            <div class="d-flex justify-content-center mb-3">
                <img id="qrCode" src="" alt="QR Code" class="img-fluid rounded shadow" style="max-width: 200px;">
            </div>
            <p class="text-muted">Phòng sẽ được đặt sau khi bạn chuyển khoản thành công.</p>
        </div>

    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("bookingForm");
        const successBanner = document.getElementById("successBanner");

        const checkIn = localStorage.getItem("checkIn") || "";
        const checkOut = localStorage.getItem("checkOut") || "";

        document.getElementById("checkInInput").value = checkIn;
        document.getElementById("checkOutInput").value = checkOut;

        document.getElementById("checkInDisplay").textContent = checkIn || "-";
        document.getElementById("checkOutDisplay").textContent = checkOut || "-";

        // Hàm kiểm tra trạng thái booking
        async function checkBookingStatus() {
            const bookingId = localStorage.getItem("lastBookingId");
            if (!bookingId) return;

            try {
                const res = await fetch(`/api/booking/${bookingId}`);
                if (!res.ok) throw new Error("Không thể lấy trạng thái booking");

                const booking = await res.json();
                if (booking.status === "CONFIRMED") {
                    successBanner.style.display = "block";
                    localStorage.removeItem("lastBookingId");
                }
            } catch (err) {
                console.error(err);
            }
        }

        // Kiểm tra khi load trang
        checkBookingStatus();

        // Submit form
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const req = {
                roomId: formData.get("roomId"),
                checkIn: formData.get("checkIn"),
                checkOut: formData.get("checkOut"),
                customerName: formData.get("customerName"),
                phone: formData.get("phone"),
                note: formData.get("note"),
                paymentMethod: formData.get("paymentMethod")
            };

            try {
                const res = await fetch("/api/booking", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(req)
                });

                if (!res.ok) throw new Error("Có lỗi xảy ra khi đặt phòng");

                const data = await res.json();

                // Lưu bookingId để check trạng thái sau
                localStorage.setItem("lastBookingId", data.idBooking);

                if (req.paymentMethod === "ONLINE" && data.qrcode) {
                    const qrBox = document.getElementById("qrBox");
                    const qrImg = document.getElementById("qrCode");

                    qrImg.src = data.qrcode;
                    qrBox.classList.remove("d-none");
                    qrBox.scrollIntoView({behavior: "smooth"});
                }

                alert("Thông tin đã được gửi đi!");
                localStorage.removeItem("checkIn");
                localStorage.removeItem("checkOut");

            } catch (err) {
                console.error(err);
                alert(err.message);
            }
        });
    });
</script>

</body>
</html>
