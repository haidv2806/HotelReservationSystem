<!DOCTYPE html>
<html lang="vi" th:fragment="datepiker">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date Picker</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <style>
        .calendar-day {
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: 0.2s;
            text-align: center;
            user-select: none;
        }
        .calendar-day:hover {
            transform: scale(1.1);
        }

        /* Ngày disabled */
        .bg-disabled {
            background-color: #dc2626 !important; /* đỏ (Tailwind red-600) */
            color: white;
            cursor: not-allowed;
        }

        /* Ngày bình thường */
        .bg-selectable {
            background-color: #38bdf8; /* sky-400 */
            color: white;
            cursor: pointer;
        }

        /* Ngày check-in */
        .bg-checkin {
            background-color: #0ea5e9 !important; /* sky-500 */
            color: white;
            font-weight: bold;
        }

        /* Ngày check-out */
        .bg-checkout {
            background-color: #0284c7 !important; /* sky-700 */
            color: white;
            font-weight: bold;
        }

        /* Ngày giữa check-in và check-out */
        .bg-range {
            background-color: #bae6fd !important; /* sky-200 */
            color: #1e3a8a; /* navy text */
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container my-4 p-3 border rounded shadow bg-white">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="prevMonth" class="btn btn-secondary btn-sm">Previous Month</button>
        <h5 id="monthDisplay" class="mb-0"></h5>
        <button id="nextMonth" class="btn btn-secondary btn-sm">Next Month</button>
    </div>

    <div class="weekdays text-muted">
        <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
    </div>

    <div id="calendar" class="calendar-grid"></div>

    <div class="mt-3">
        <label class="form-label me-2">Ngày nhận phòng</label>
        <input type="text" id="checkInInput" name="checkIn" readonly class="form-control d-inline-block w-auto">
    </div>
    <div class="mt-3">
        <label class="form-label ms-3 me-2">Ngày trả phòng</label>
        <input type="text" id="checkOutInput" name="checkOut" readonly class="form-control d-inline-block w-auto">
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const blockDates = /*[[${room.blockDate}]]*/ [];
    const calendarEl = document.getElementById("calendar");
    const prevMonthBtn = document.getElementById("prevMonth");
    const nextMonthBtn = document.getElementById("nextMonth");
    const monthDisplay = document.getElementById("monthDisplay");

    let currentMonthStart = dayjs().startOf("month");
    const today = dayjs().startOf("day");

    let selectedDates = {
        checkIn: localStorage.getItem('checkIn') || null,
        checkOut: localStorage.getItem('checkOut') || null
    };

    document.getElementById("checkInInput").value = selectedDates.checkIn || "";
    document.getElementById("checkOutInput").value = selectedDates.checkOut || "";

    function renderCalendar(monthStart) {
        calendarEl.innerHTML = "";
        monthDisplay.textContent = monthStart.format("MMMM YYYY");

        const endOfMonth = monthStart.endOf("month");
        const daysInMonth = endOfMonth.date();
        let startDay = monthStart.day();
        if (startDay === 0) startDay = 7; // Sunday = 7

        // empty cells trước ngày đầu tháng
        for (let i = 1; i < startDay; i++) calendarEl.appendChild(document.createElement("div"));

        for (let d = 1; d <= daysInMonth; d++) {
            const date = monthStart.date(d);
            const dateStr = date.format("YYYY-MM-DD");
            const cell = document.createElement("div");
            cell.textContent = d;
            cell.classList.add("calendar-day");

            if (date.isBefore(today, "day") || blockDates.includes(dateStr)) {
                cell.classList.add("bg-disabled");
            } else {
                cell.classList.add("bg-selectable");

                cell.addEventListener("click", () => {
                    if (!selectedDates.checkIn) {
                        selectedDates.checkIn = dateStr;
                        localStorage.setItem('checkIn', dateStr);
                        document.getElementById("checkInInput").value = dateStr;
                    } else if (!selectedDates.checkOut) {
                        if (dayjs(dateStr).isBefore(selectedDates.checkIn)) {
                            alert("Ngày trả phải sau ngày nhận");
                            return;
                        }
                        selectedDates.checkOut = dateStr;
                        localStorage.setItem('checkOut', dateStr);
                        document.getElementById("checkOutInput").value = dateStr;
                    } else {
                        selectedDates.checkIn = dateStr;
                        selectedDates.checkOut = null;
                        localStorage.setItem('checkIn', dateStr);
                        localStorage.removeItem('checkOut');
                        document.getElementById("checkInInput").value = dateStr;
                        document.getElementById("checkOutInput").value = "";
                    }
                    renderCalendar(currentMonthStart);
                });
            }

            // tô màu check-in / check-out / range
            if (selectedDates.checkIn === dateStr) cell.classList.add("bg-checkin");
            if (selectedDates.checkOut === dateStr) cell.classList.add("bg-checkout");
            if (selectedDates.checkIn && selectedDates.checkOut &&
                dayjs(dateStr).isAfter(selectedDates.checkIn) &&
                dayjs(dateStr).isBefore(selectedDates.checkOut)) {
                cell.classList.add("bg-range");
            }

            calendarEl.appendChild(cell);
        }
    }

    renderCalendar(currentMonthStart);

    prevMonthBtn.addEventListener("click", () => {
        currentMonthStart = currentMonthStart.subtract(1, "month").startOf("month");
        renderCalendar(currentMonthStart);
    });

    nextMonthBtn.addEventListener("click", () => {
        currentMonthStart = currentMonthStart.add(1, "month").startOf("month");
        renderCalendar(currentMonthStart);
    });
    /*]]>*/
</script>

</body>
</html>
