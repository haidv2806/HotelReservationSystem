<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<body th:fragment="chatbox" class="text-gray-800">
    <!-- N√∫t b·∫≠t/t·∫Øt chatbox -->
    <button id="toggleChat"
        class="fixed bottom-4 right-4 w-12 h-12 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 transition-transform hover:scale-110 z-50">üí¨</button>

    <!-- Chatbox -->
    <div id="chatbox"
        class="fixed bottom-20 right-4 max-w-[25%] min-w-[200px] h-1/2 hidden bg-white border border-gray-200 rounded-2xl shadow-2xl flex flex-col overflow-hidden transition-all duration-300 z-50">

        <!-- Header -->
        <div
            class="bg-gradient-to-r from-indigo-600 to-indigo-500 text-white p-3 text-sm font-semibold flex justify-between items-center rounded-t-2xl">
            <span>üí¨ Chat h·ªó tr·ª£</span>
            <button id="closeChat" class="text-white text-xs bg-white/20 hover:bg-white/30 rounded px-2 py-1">‚úï</button>
        </div>

        <!-- V√πng tin nh·∫Øn -->
        <div id="messages" class="flex-1 overflow-auto p-3 flex flex-col space-y-2 text-sm bg-gray-50 text-gray-800">
            <div
                class="self-start bg-white shadow-sm p-2 rounded-2xl rounded-bl-none border border-gray-200 w-fit max-w-[80%]">
                Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?
            </div>
        </div>

        <!-- √î nh·∫≠p -->
        <form id="composer" class="border-t border-gray-200 p-2 bg-white flex items-center gap-2">
            <input id="input" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..."
                class="flex-1 text-sm px-3 py-2 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-300 text-gray-800 transition" />
            <button type="submit"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 text-sm rounded-full shadow-sm transition">G·ª≠i</button>
        </form>
    </div>

    <script>
        const toggleChat = document.getElementById('toggleChat');
        const chatbox = document.getElementById('chatbox');
        const closeChat = document.getElementById('closeChat');
        const composer = document.getElementById('composer');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');

        // 1. KHAI B√ÅO BI·∫æN L·ªäCH S·ª¨
        let chatHistory = [];

        // H√†m t·∫°o tin nh·∫Øn tr√™n giao di·ªán
        function appendMessage(sender, content, isLink = false) {
            const msg = document.createElement('div');
            msg.className = sender === 'USER'
                ? 'self-end bg-indigo-600 text-white p-2 rounded-2xl rounded-br-none w-fit max-w-[80%] text-right shadow-sm'
                : 'self-start bg-white border border-gray-200 p-2 rounded-2xl rounded-bl-none w-fit max-w-[80%] text-left shadow-sm text-gray-800';

            if (isLink) {
                // N·∫øu n·ªôi dung ch·ª©a Markdown Link, chuy·ªÉn ƒë·ªïi n√≥ sang HTML
                msg.innerHTML = convertMarkdownLinksToHtml(content);
            } else {
                msg.textContent = content;
            }

            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        // H√†m chuy·ªÉn ƒë·ªïi [Text](URL) sang <a href="URL">Text</a>
        function convertMarkdownLinksToHtml(text) {
            // Regex t√¨m ki·∫øm c√∫ ph√°p [text](url)
            const linkRegex = /\[([^\]]+)\]\((http[s]?:\/\/[^\s]+)\)/g;
            return text.replace(linkRegex, '<a href="$2" target="_blank" class="text-indigo-600 underline font-medium hover:text-indigo-700">$1</a>');
        }

        // 2. H√ÄM G·ªåI API B·∫§T ƒê·ªíNG B·ªò
        async function sendMessage(userMessage) {
            // T·∫°o ƒë·ªëi t∆∞·ª£ng ChatRequest
            const requestBody = {
                message: userMessage,
                history: chatHistory
            };

            // B·∫≠t tr·∫°ng th√°i loading
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'self-start text-gray-500 text-xs mt-1';
            loadingMessage.textContent = 'Bot ƒëang tr·∫£ l·ªùi...';
            messages.appendChild(loadingMessage);
            messages.scrollTop = messages.scrollHeight;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('L·ªói API: ' + response.statusText);
                }

                const botResponse = await response.text();

                // X√≥a loading message
                messages.removeChild(loadingMessage);

                // Th√™m ph·∫£n h·ªìi c·ªßa Bot
                appendMessage('ASSISTANT', botResponse, true); // G·ª≠i c·ªù 'true' ƒë·ªÉ x·ª≠ l√Ω link

                // 3. C·∫¨P NH·∫¨T L·ªäCH S·ª¨ TR√í CHUY·ªÜN
                chatHistory.push(`USER: ${userMessage}`);
                chatHistory.push(`ASSISTANT: ${botResponse}`);

            } catch (error) {
                console.error('L·ªói khi g·ª≠i tin nh·∫Øn:', error);
                messages.removeChild(loadingMessage);
                appendMessage('ASSISTANT', 'Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // G·∫Øn s·ª± ki·ªán
        toggleChat.addEventListener('click', () => {
            chatbox.classList.toggle('hidden');
        });

        closeChat.addEventListener('click', () => {
            chatbox.classList.add('hidden');
        });

        composer.addEventListener('submit', (e) => {
            e.preventDefault();
            const value = input.value.trim();
            if (!value) return;

            // Th√™m tin nh·∫Øn ng∆∞·ªùi d√πng v√†o giao di·ªán
            appendMessage('USER', value);
            input.value = '';

            // G·ª≠i tin nh·∫Øn ƒë·∫øn API
            sendMessage(value);
        });

        // Kh·ªüi t·∫°o l·ªãch s·ª≠ v·ªõi tin nh·∫Øn ch√†o m·ª´ng m·∫∑c ƒë·ªãnh
        // L∆∞u √Ω: N·∫øu mu·ªën tin nh·∫Øn ch√†o m·ª´ng m·∫∑c ƒë·ªãnh n√†y ƒë∆∞·ª£c AI ghi nh·ªõ, b·∫°n ph·∫£i ƒë·ªãnh nghƒ©a n√≥ trong System Message.
        // N·∫øu kh√¥ng, ch·ªâ c·∫ßn tin nh·∫Øn ch√†o m·ª´ng ng∆∞·ªùi d√πng (·ªü ƒë√¢y l√† tin nh·∫Øn c·ªßa Bot)
        chatHistory.push(`ASSISTANT: Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?`); 
    </script>
</body>

</html>