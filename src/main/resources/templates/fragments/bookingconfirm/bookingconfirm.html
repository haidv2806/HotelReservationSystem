<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <title>Danh s√°ch Bookings</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body th:fragment="bookingconfirm" class="bg-gray-100">

    <div class="max-w-7xl mx-auto py-6 px-4">

        <h1 class="text-2xl font-bold mb-4">Danh s√°ch Bookings</h1>

        <!-- üîç Form search -->
        <form th:action="@{/dashboard/bookingconfirm}" method="get"
            class="flex flex-wrap gap-4 bg-white p-4 rounded shadow mb-6">
            <input type="text" name="search" placeholder="Nh·∫≠p t√™n, s·ªë ƒëi·ªán tho·∫°i ho·∫∑c ph√≤ng..."
                th:value="${param.search}" class="border p-2 rounded w-64" />

            <label class="flex items-center gap-2">
                Check-in t·ª´:
                <input type="date" name="checkinDate" th:value="${param.start}" class="border p-2 rounded" />
            </label>

            <label class="flex items-center gap-2">
                ƒë·∫øn:
                <input type="date" name="checkoutDate" th:value="${param.end}" class="border p-2 rounded" />
            </label>

            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                üîç T√¨m ki·∫øm
            </button>
            <!-- üîÅ N√∫t Reset -->
            <a th:href="@{/dashboard/bookingconfirm}"
                class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">
                üîÑ Reset
            </a>
        </form>

        <!-- üìã B·∫£ng bookings -->
        <div class="bg-white rounded shadow overflow-hidden">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-200 text-left">
                    <tr>
                        <th class="px-4 py-2">ID</th>
                        <th class="px-4 py-2">Room</th>
                        <th class="px-4 py-2">Customer</th>
                        <th class="px-4 py-2">Check-in/Check-out</th>
                        <th class="px-4 py-2">Note</th>
                        <th class="px-4 py-2">Total Price</th>
                        <th class="px-4 py-2">Status</th>
                        <!-- <th class="px-4 py-2">Action</th> -->
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="b : ${bookings}" class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2" th:text="${b.idBooking}"></td>
                        <td class="px-4 py-2" th:text="${b.roomName}"></td>
                        <td class="px-4 py-2" th:text="${b.customerName}"></td>
                        <!--                <td class="px-4 py-2" th:text="${#temporals.format(b.checkinDate, 'dd-MM-yyyy')}"></td>-->
                        <!--                <td class="px-4 py-2" th:text="${#temporals.format(b.checkoutDate, 'dd-MM-yyyy')}"></td>-->
                        <td class="px-4 py-2">
                            <span th:text="${#temporals.format(b.checkinDate, 'dd-MM-yyyy')}"></span>
                            ‚Üí
                            <span th:text="${#temporals.format(b.checkoutDate, 'dd-MM-yyyy')}"></span>
                        </td>
                        <td class="px-4 py-2 italic text-gray-600" th:text="${b.note ?: 'N/A'}"></td>
                        <td class="px-4 py-2 font-semibold text-blue-600"
                            th:text="${#numbers.formatDecimal(b.totalPrice ?: 0, 0, 'POINT', 2, 'POINT')}"></td>
                        <td class="px-4 py-2">
                            <select th:id="'status-' + ${b.idBooking}"
                                th:onchange="'changeBookingStatus(' + ${b.idBooking} + ', this.value)'"
                                class="border rounded px-2 py-1">
                                <option value="PENDING" th:selected="${b.status == 'PENDING'}">PENDING</option>
                                <option value="CONFIRMED" th:selected="${b.status == 'CONFIRMED'}">CONFIRMED</option>
                                <option value="CHECKED_IN" th:selected="${b.status == 'CHECKED_IN'}">CHECKED_IN</option>
                                <option value="CHECKED_OUT" th:selected="${b.status == 'CHECKED_OUT'}">CHECKED_OUT
                                </option>
                                <option value="CANCELLED" th:selected="${b.status == 'CANCELLED'}">CANCELLED</option>
                            </select>
                        </td>
                        <!-- üóëÔ∏è N√∫t X√≥a -->
                        <!-- <td class="px-4 py-2 text-center">
                            <button type="button" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-blue-700"
                                th:onclick="'deleteBooking(' + ${b.idBooking} + ')'">
                                üóëÔ∏è
                            </button>
                        </td> -->
                    </tr>
                    <tr th:if="${#lists.isEmpty(bookings)}">
                        <td colspan="8" class="text-center py-4 text-gray-500">Kh√¥ng c√≥ booking n√†o</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- üìå Th√¥ng tin ph√¢n trang -->
        <div class="flex justify-between items-center mt-4">
            <p class="text-gray-600">
                Trang <span th:text="${currentPage + 1}"></span> / <span th:text="${totalPages}"></span>
                (T·ªïng <span th:text="${totalElements}"></span> bookings)
            </p>

            <!-- üîÄ N√∫t ph√¢n trang -->
            <div class="flex gap-2">
                <a th:if="${currentPage > 0}"
                    th:href="@{/dashboard/bookingconfirm(page=${currentPage - 1}, size=${param.size != null ? param.size : 10}, search=${search}, start=${start}, end=${end})}"
                    class="px-3 py-1 border rounded bg-gray-200 hover:bg-gray-300">¬´ Tr∆∞·ªõc</a>

                <a th:if="${currentPage + 1 < totalPages}"
                    th:href="@{/dashboard/bookingconfirm(page=${currentPage + 1}, size=${param.size != null ? param.size : 10}, search=${search}, start=${start}, end=${end})}"
                    class="px-3 py-1 border rounded bg-gray-200 hover:bg-gray-300">Sau ¬ª</a>
            </div>
        </div>
    </div>
    <script>
        async function changeBookingStatus(bookingId, status) {
            const body = { status: status };
            console.log("Sending body:", body);

            try {
                const response = await fetch(`/api/booking/${bookingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    // Reload trang sau khi update th√†nh c√¥ng
                    location.reload();
                } else {
                    const err = await response.text();
                    alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + err);
                }
            } catch (error) {
                console.error(error);
                alert("L·ªói khi g·ª≠i request");
            }
        }

        async function deleteBooking(bookingId) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a booking n√†y kh√¥ng?")) return;

            try {
                const response = await fetch(`/api/booking/${bookingId}`, { method: 'DELETE' });

                if (response.ok) {
                    alert("ƒê√£ x√≥a booking th√†nh c√¥ng!");
                    location.reload();
                } else {
                    const err = await response.text();
                    alert("X√≥a th·∫•t b·∫°i: " + err);
                }
            } catch (error) {
                console.error(error);
                alert("L·ªói khi g·ª≠i y√™u c·∫ßu x√≥a!");
            }
        }
    </script>

</body>

</html>