<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Customer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body th:fragment="customer" class="bg-gray-100 p-8">

<h1 class="text-3xl font-bold mb-4 text-gray-800">Customer Dashboard</h1>

<!-- Ô tìm kiếm -->
<div class="mb-6 flex items-center justify-between">
  <input type="text"
         id="searchInput"
         placeholder="Tìm kiếm theo tên hoặc số điện thoại..."
         class="w-full md:w-1/3 px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
         onkeyup="searchCustomers()">
</div>

<!-- Bảng khách hàng -->
<div class="overflow-x-auto bg-white rounded-lg shadow-lg">
  <table id="customerTable" class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-200">
    <tr>
      <th class="px-6 py-3 text-left text-sm font-bold">ID</th>
      <th class="px-6 py-3 text-left text-sm font-bold">Customer Name</th>
      <th class="px-6 py-3 text-left text-sm font-bold">Phone</th>
      <th class="px-6 py-3 text-left text-sm font-bold">Status</th>
      <th class="px-6 py-3 text-center text-sm font-bold">Action</th>
    </tr>
    </thead>

    <tbody id="customerBody" class="bg-white divide-y divide-gray-200">
    <tr th:each="c : ${customers}" class="hover:bg-gray-50 transition-colors">
      <td class="px-6 py-4 text-sm text-gray-700" th:text="${c.customerId}"></td>
      <td class="px-6 py-4 text-sm text-gray-900" th:text="${c.customerName}"></td>
      <td class="px-6 py-4 text-sm text-gray-600" th:text="${c.phone}"></td>
      <td class="px-6 py-4 text-sm font-semibold">
          <span th:if="${c.status.name() == 'normal'}"
                class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold">Normal</span>
        <span th:if="${c.status.name() == 'blacklist'}"
              class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-bold">Blacklist</span>
      </td>
      <td class="px-6 py-4 flex justify-center gap-2">
        <button th:if="${c.status.name() == 'normal'}"
                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full transition"
                th:onclick="|changeStatus(${c.customerId}, 'blacklist')|">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v3m0 4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9
                       4.03-9 9-9 9 4.03 9 9z"/>
          </svg>
        </button>

        <button th:if="${c.status.name() == 'blacklist'}"
                class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full transition"
                th:onclick="|changeStatus(${c.customerId}, 'normal')|">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M5 13l4 4L19 7"/>
          </svg>
        </button>
      </td>
    </tr>

    <tr th:if="${#lists.isEmpty(customers)}">
      <td colspan="5" class="py-6 text-center text-gray-400 text-lg">Không có dữ liệu</td>
    </tr>
    </tbody>
  </table>
</div>

<!-- Phân trang -->
<div class="flex justify-between items-center mt-6">
  <p class="text-gray-600 text-sm">
    Trang <span th:text="${currentPage + 1}"></span> / <span th:text="${totalPages}"></span>
  </p>

  <div class="flex gap-2">
    <a th:if="${currentPage > 0}"
       th:href="@{/dashboard/customer(page=${currentPage - 1})}"
       class="px-4 py-2 border rounded bg-gray-200 hover:bg-gray-300 transition">« Trước</a>

    <a th:if="${currentPage + 1 < totalPages}"
       th:href="@{/dashboard/customer(page=${currentPage + 1})}"
       class="px-4 py-2 border rounded bg-gray-200 hover:bg-gray-300 transition">Sau »</a>
  </div>
</div>
<script>
  async function changeStatus(customer_id, status) {
    const body = { customerId: customer_id, status: status };
    const response = await fetch('/api/customer/customer_status', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (response.ok) {
      location.reload();
    } else {
      const err = await response.text();
      alert("Cập nhật thất bại: " + err);
    }
  }

  //Tìm kiếm dữ liệu trong DATABASE
  let typingTimer;
  function searchCustomers() {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(async () => {
      const keyword = document.getElementById("searchInput").value.trim();
      const tbody = document.getElementById("customerBody");

      try {
        const response = await fetch(`/api/customer/search?keyword=${encodeURIComponent(keyword)}`);
        const data = await response.json();

        tbody.innerHTML = "";

        if (data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="py-6 text-center text-gray-400 text-lg">Không có dữ liệu</td></tr>`;
          return;
        }

        data.forEach(c => {
          tbody.innerHTML += `
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-6 py-4 text-sm text-gray-700">${c.customerId}</td>
              <td class="px-6 py-4 text-sm text-gray-900">${c.customerName}</td>
              <td class="px-6 py-4 text-sm text-gray-600">${c.phone}</td>
              <td class="px-6 py-4 text-sm font-semibold">
                ${c.status === 'normal'
                  ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold">Normal</span>'
                  : '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-bold">Blacklist</span>'}
              </td>
              <td class="px-6 py-4 flex justify-center gap-2">
                ${c.status === 'normal'
                  ? `<button class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full transition" onclick="changeStatus(${c.customerId}, 'blacklist')">
                      <svg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 9v3m0 4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z'/>
                      </svg>
                    </button>`
                  : `<button class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full transition" onclick="changeStatus(${c.customerId}, 'normal')">
                      <svg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 13l4 4L19 7'/>
                      </svg>
                    </button>`}
              </td>
            </tr>`;
        });
      } catch (e) {
        console.error("Search error:", e);
      }
    }, 300); // debounce 300ms
  }
</script>

</body>
</html>
